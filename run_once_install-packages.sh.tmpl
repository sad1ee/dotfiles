#!/bin/sh

set -e

{{ if eq .osid "linux-arch" -}}

USER_TO_ENABLE="user"
GROUP="wheel"
SUDOERS_FILE="/etc/sudoers.d/99-$USER_TO_ENABLE-nopasswd"
if ! id -nG "$USER_TO_ENABLE" | grep -qw "$GROUP"; then
    sudo usermod -aG "$GROUP" "$USER_TO_ENABLE"
fi
if [ ! -f "$SUDOERS_FILE" ]; then
    echo "$USER_TO_ENABLE ALL=(ALL) NOPASSWD: ALL" | sudo tee "$SUDOERS_FILE" >/dev/null
    sudo chmod 440 "$SUDOERS_FILE"
fi
sudo -k

if ! command -v yay &>/dev/null; then
  sudo pacman -S --needed git base-devel
  git clone https://aur.archlinux.org/yay-bin.git /tmp/yay-bin
  cd /tmp/yay-bin
  makepkg -si --noconfirm
fi

yay -Syu --needed --noconfirm {{ range .packages.arch.yay }}{{ . | quote }} {{ end }}

[ -x /usr/share/tmux-plugin-manager/bin/install_plugins ] &&
  /usr/share/tmux-plugin-manager/bin/install_plugins

FONT_DIR="$HOME/.local/share/fonts"
mkdir -p "$FONT_DIR"
curl -L -o "$FONT_DIR/OleoScript-Regular.ttf" \
    "https://github.com/google/fonts/raw/main/ofl/oleoscript/OleoScript-Regular.ttf"
fc-cache -fv

chsh -s $(which zsh)

{{ end -}}

{{ if eq .osid "linux-ubuntu" -}}

USER_TO_ENABLE="user"
GROUP="sudo"
SUDOERS_FILE="/etc/sudoers.d/99-$USER_TO_ENABLE-nopasswd"
if ! id -nG "$USER_TO_ENABLE" | grep -qw "$GROUP"; then
    sudo usermod -aG "$GROUP" "$USER_TO_ENABLE"
fi
if [ ! -f "$SUDOERS_FILE" ]; then
    echo "$USER_TO_ENABLE ALL=(ALL) NOPASSWD: ALL" | sudo tee "$SUDOERS_FILE" >/dev/null
    sudo chmod 440 "$SUDOERS_FILE"
fi
sudo -k

sudo add-apt-repository -y ppa:zhangsongcui3371/fastfetch

sudo apt update

sudo apt install -y {{ range .packages.ubuntu.apt }}{{ . | quote }} {{ end }}

if ! command -v oh-my-posh >/dev/null 2>&1; then
  curl -s https://ohmyposh.dev/install.sh | bash -s -- -d "${HOME}/.local/bin"
fi

[ -x /usr/share/tmux-plugin-manager/bin/install_plugins ] &&
  /usr/share/tmux-plugin-manager/bin/install_plugins

FONT_DIR="$HOME/.local/share/fonts"
mkdir -p "$FONT_DIR"
curl -L -o "$FONT_DIR/SymbolsNerdFontMono-Regular.ttf" \
  "https://github.com/ryanoasis/nerd-fonts/raw/refs/heads/master/patched-fonts/NerdFontsSymbolsOnly/SymbolsNerdFontMono-Regular.ttf"
fc-cache -fv

sudo ln -s /usr/bin/batcat /usr/local/bin/bat

chsh -s $(which zsh)

sudo apt remove rbw

{{ end -}}
